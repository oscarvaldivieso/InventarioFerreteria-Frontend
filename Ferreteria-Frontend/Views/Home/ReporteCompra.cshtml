@model IEnumerable<CompraViewModel>

@{
    ViewData["Title"] = "Reporte Compra";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-md-4">
        <form method="get" asp-action="ReporteCompra">
            <label class="control-label">Fecha Inicio</label>
            <input type="date" id="fechaInicio" name="fechaInicio" class="form-control" />
            <label class="control-label">Fecha Fin</label>
            <input type="date" id="fechaFin" name="fechaFin" class="form-control" />
        </form>
    </div>
</div>
<iframe id="pdfPreview" width="100%" height="500px"></iframe>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        generarVistaPrevia();
    });

    function generarVistaPrevia() {
        var compras = @Html.Raw(Json.Serialize(Model));

        var { jsPDF } = window.jspdf;
        var doc = new jsPDF();

        var usuarioSesion = "@ViewBag.UsuarioSesion";
        var fechaHoraActual = new Date().toLocaleString();

        doc.setProperties({
            title: "Reporte de Compras",
            subject: "Compras Filtradas",
            author: usuarioSesion,
            keywords: "Compras, Reporte, PDF",
            creator: "Sistema de Gestión"
        });

        doc.addImage("@Url.Content("~/images/Logo__2_-removebg-preview.png")", "PNG", 30, 0, 29, 29);
        doc.setFontSize(16);
        doc.text("Listado de Compras", 60, 17, 0, 0);

        var columnas = ["ID", "Proveedor", "Fecha De Compra", "Producto", "Cantidad", "Precio"];
        var filas = compras.map(c => [
            c.comp_Id,
            c.prov_Nombre,
            c.comp_Fecha,
            c.prod_Descripcion,
            c.cpde_Cantidad,
            c.cpde_Precio
        ]);

        doc.autoTable({
            head: [columnas],
            body: filas,
            startY: 28,
            theme: 'grid',
            headStyles: { fillColor: [169, 143, 64], textColor: [255, 255, 255], fontStyle: 'bold' },
            didDrawPage: function (data) {
                var pageSize = doc.internal.pageSize;
                var pageWidth = pageSize.width;
                var pageHeight = pageSize.height;
                var pageNumber = doc.internal.getNumberOfPages();

                doc.setDrawColor(150);
                doc.line(20, pageHeight - 15, pageWidth - 20, pageHeight - 15);

                doc.setFontSize(10);
                doc.text(`Generado por: ${usuarioSesion}`, 20, pageHeight - 10);
                doc.text(`Fecha y Hora: ${fechaHoraActual}`, pageWidth / 2, pageHeight - 10, { align: "center" });
                doc.text(`Página ${pageNumber}`, pageWidth - 20, pageHeight - 10, { align: "right" });
            }
        });

        var pdfBlob = doc.output("blob");
        var pdfUrl = URL.createObjectURL(pdfBlob);

        document.getElementById("pdfPreview").src = pdfUrl;

        window.generatedPDF = doc;
    }
</script>